<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Csal√°di Napl√≥</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --main: #4a90e2; --accent: #50e3c2; --bg: #f5f7fa; --danger: #ff6b6b; --warn: #f8e71c; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; user-select: none; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; padding: 20px; border-radius: 10px; width: 85%; max-width: 320px; text-align: center; color: #333; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        
        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top:0; z-index:100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.3rem; color: var(--main); }
        .user-badge { background: var(--main); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        /* TABOK */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; animation: fadein 0.3s; }
        .tab-content.active { display: block; }

        /* K√ÅRTY√ÅK */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid #ccc; position: relative; }
        .status-todo { border-left-color: var(--warn); }
        .status-done { border-left-color: var(--accent); background: #f0fcf9; opacity: 0.8; }
        .status-planned { border-left-color: var(--main); }

        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-cat { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #999; font-weight: bold; margin-bottom: 2px; }
        .task-name { font-size: 1.1rem; font-weight: 700; color: #2c3e50; }
        .task-detail { font-size: 0.85rem; color: #666; margin-top: 4px; font-style: italic; }
        
        /* TERVEZ√âS INFO */
        .plan-info { background: #eef6ff; color: var(--main); padding: 5px 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 10px; display: inline-block; border: 1px solid #cfe2ff; }

        /* GOMBOK */
        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        button { border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 0.9rem; transition: 0.2s; color: white; }
        button:active { transform: scale(0.98); }
        .btn-done { background: var(--accent); color: #00796b; }
        .btn-plan { background: #ddd; color: #555; }
        .btn-primary { background: var(--main); width: 100%; }
        .btn-danger { background: var(--danger); }
        
        /* SPECI√ÅLIS INPUTOK */
        select, input[type="number"], input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; background: white; }
        
        /* HETI V√ÅLASZT√ì GOMBOK */
        .week-selector { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 15px; }
        .day-btn { padding: 8px 0; flex: 1; text-align: center; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.8rem; color: #333; }
        .day-btn.selected { background: var(--main); color: white; border-color: var(--main); }

        /* KATEG√ìRIA CHIPS */
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; margin-bottom: 15px; }
        .chip { background: #eee; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .chip.active { background: var(--main); color: white; }
        .chip-del { font-size: 0.8rem; opacity: 0.6; padding: 0 4px; }
        
        /* NAVBAR */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; display: flex; height: 70px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; font-size: 0.75rem; }
        .nav-item.active { color: var(--main); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }

        /* STATISZTIKA */
        .stat-bar { height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin: 20px 0; display: flex; }
        .stat-fill { height: 100%; background: var(--accent); transition: width 0.5s; }

        @keyframes fadein { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--main); margin-top:0;">üè† Csal√°di Napl√≥</h2>
        <input type="text" id="family-code" placeholder="Csal√°d K√≥dja (pl. Kovacs√©k)">
        <input type="text" id="user-name" placeholder="Te Neved (pl. Apa)">
        <button class="btn-primary" onclick="login()">Bel√©p√©s</button>
        <p style="font-size:0.75rem; color:#888; margin-top:15px;">K√∂z√∂s lista, k√∂z√∂s felel≈ëss√©g.</p>
    </div>
</div>

<div id="app" style="display:none;">
    <header>
        <h1>Mai Teend≈ëk</h1>
        <div class="user-badge" id="display-user"></div>
    </header>

    <div class="container">
        <div id="tab-today" class="tab-content active">
            <div id="today-date" style="text-align:center; color:#888; margin-bottom:15px; font-size:0.9rem;"></div>
            
            <div class="stat-bar">
                <div id="daily-progress" class="stat-fill" style="width: 0%"></div>
            </div>
            
            <div id="task-list"></div>
            
            <div id="empty-msg" style="text-align:center; color:#aaa; margin-top:50px; display:none;">
                <h2>‚òÄÔ∏è</h2>
                <p>M√°ra minden k√©sz!</p>
            </div>
            
            <button onclick="checkAndGenerateDaily()" style="margin-top:30px; background:none; color:#aaa; font-size:0.8rem; width:100%;">üîÑ Lista friss√≠t√©se</button>
        </div>

        <div id="tab-summary" class="tab-content">
            <div class="card">
                <h3>üìä Heti √ñsszes√≠t≈ë</h3>
                <div style="display:flex; justify-content:space-around; text-align:center; margin: 20px 0;">
                    <div>
                        <div style="font-size:1.5rem; font-weight:bold; color:var(--main);" id="stat-total">0</div>
                        <div style="font-size:0.8rem;">Feladat</div>
                    </div>
                    <div>
                        <div style="font-size:1.5rem; font-weight:bold; color:var(--accent);" id="stat-done">0</div>
                        <div style="font-size:0.8rem;">Elv√©gezve</div>
                    </div>
                </div>
            </div>
            <h3>Legut√≥bbi aktivit√°sok</h3>
            <div id="history-list"></div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0;">‚ûï √öj feladat defini√°l√°sa</h3>
                
                <label>Feladat Neve</label>
                <input type="text" id="new-name" placeholder="pl. G√°z√≥ra dikt√°l√°s">
                
                <label>Kateg√≥ria</label>
                <input type="text" id="new-cat" placeholder="pl. Kert, Hivatal..." oninput="filterCats()">
                <div id="cat-chips" class="chip-container"></div>

                <label>Gyakoris√°g T√≠pusa</label>
                <select id="freq-type" onchange="renderFreqOptions()">
                    <option value="daily">Napi / Heti rendszeres</option>
                    <option value="monthly_date">Havi fix napon (pl. 12-√©n)</option>
                    <option value="monthly_pos">Havi minta (pl. Els≈ë H√©tf≈ë)</option>
                </select>

                <div id="opt-daily" style="display:block;">
                    <div class="week-selector">
                        <div class="day-btn" onclick="toggleDay(this, 1)">H</div>
                        <div class="day-btn" onclick="toggleDay(this, 2)">K</div>
                        <div class="day-btn" onclick="toggleDay(this, 3)">Sz</div>
                        <div class="day-btn" onclick="toggleDay(this, 4)">Cs</div>
                        <div class="day-btn" onclick="toggleDay(this, 5)">P</div>
                        <div class="day-btn" onclick="toggleDay(this, 6)">Sz</div>
                        <div class="day-btn" onclick="toggleDay(this, 0)">V</div>
                    </div>
                </div>

                <div id="opt-monthly-date" style="display:none;">
                    <label>A h√≥nap melyik napj√°n?</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" id="month-day-fix" min="1" max="31" value="10">. napj√°n
                    </div>
                    <div style="font-size:0.8rem; color:#888; margin-top:-5px; margin-bottom:10px;">
                        (Pl. befizet√©sekhez: 10-e k√∂r√ºl)
                    </div>
                </div>

                <div id="opt-monthly-pos" style="display:none;">
                    <label>Mikor?</label>
                    <div style="display:flex; gap:5px;">
                        <select id="month-pos-num">
                            <option value="1">Els≈ë</option>
                            <option value="2">M√°sodik</option>
                            <option value="3">Harmadik</option>
                            <option value="4">Negyedik</option>
                            <option value="-1">Utols√≥</option>
                        </select>
                        <select id="month-pos-day">
                            <option value="1">H√©tf≈ë</option>
                            <option value="2">Kedd</option>
                            <option value="3">Szerda</option>
                            <option value="4">Cs√ºt√∂rt√∂k</option>
                            <option value="5">P√©ntek</option>
                            <option value="6">Szombat</option>
                            <option value="0">Vas√°rnap</option>
                        </select>
                    </div>
                    <div style="font-size:0.8rem; color:#888; margin-top:5px; margin-bottom:10px;">
                        (Pl. Iskolai csomag: Havi Els≈ë H√©tf≈ë)
                    </div>
                </div>

                <button class="btn-primary" onclick="addNewTask()">Hozz√°ad√°s</button>
            </div>

            <h3>Mentett Feladatok</h3>
            <div id="manage-list"></div>

            <div style="margin-top: 40px; margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                <button class="btn-danger" onclick="logout()">üö™ Kil√©p√©s / Csal√°dv√°lt√°s</button>
            </div>
        </div>
    </div>
</div>

<nav id="navbar" style="display:none;">
    <div class="nav-item active" onclick="switchTab('tab-today', this)">
        <span class="nav-icon">üìÖ</span> Ma
    </div>
    <div class="nav-item" onclick="switchTab('tab-summary', this)">
        <span class="nav-icon">üìà</span> √ñsszes√≠t≈ë
    </div>
    <div class="nav-item" onclick="switchTab('tab-settings', this)">
        <span class="nav-icon">‚öôÔ∏è</span> Feladatok
    </div>
</nav>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4cCZROENWwtdJSw8RibOOoUcyzhWvmKM",
        authDomain: "csaladifeladatok.firebaseapp.com",
        projectId: "csaladifeladatok",
        storageBucket: "csaladifeladatok.firebasestorage.app",
        messagingSenderId: "391183062816",
        appId: "1:391183062816:web:0bf885d26c67447c50e945"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. √ÅLLAPOT ---
    let state = {
        famId: localStorage.getItem('famId') || '',
        user: localStorage.getItem('user') || '',
        tasks: [], 
        daily: [],
        categories: [],
        todayStr: new Date().toISOString().split('T')[0]
    };

    // --- 3. LOGIN & INIT ---
    if(state.famId && state.user) startApp();

    function login() {
        const f = document.getElementById('family-code').value.trim();
        const u = document.getElementById('user-name').value.trim();
        if(!f || !u) return alert("K√©rlek t√∂lts ki mindent!");
        state.famId = f; state.user = u;
        localStorage.setItem('famId', f); localStorage.setItem('user', u);
        startApp();
    }

    function logout() {
        if(confirm("Biztosan ki akarsz l√©pni?")) {
            localStorage.removeItem('famId'); localStorage.removeItem('user');
            location.reload();
        }
    }

    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('navbar').style.display = 'flex';
        document.getElementById('display-user').innerText = state.user;
        document.getElementById('today-date').innerText = new Date().toLocaleDateString('hu-HU', {weekday:'long', month:'long', day:'numeric'});
        setupListeners();
    }

    function setupListeners() {
        const famRef = db.collection('families').doc(state.famId);
        
        // KATEG√ìRI√ÅK
        famRef.collection('meta').doc('settings').onSnapshot(doc => {
            if(doc.exists) state.categories = doc.data().categories || [];
            else famRef.collection('meta').doc('settings').set({ categories: [] });
            renderCategoryChips();
        });

        // FELADATOK
        famRef.collection('tasks').onSnapshot(snap => {
            state.tasks = [];
            snap.forEach(d => state.tasks.push({id: d.id, ...d.data()}));
            renderManageList();
            checkAndGenerateDaily();
        });

        // NAPI TEEND≈êK
        famRef.collection('daily').doc(state.todayStr).onSnapshot(doc => {
            if(doc.exists) { state.daily = doc.data().items || []; renderToday(); }
            else { checkAndGenerateDaily(); }
        });

        // HISTORY
        famRef.collection('history').orderBy('ts', 'desc').limit(20).onSnapshot(snap => {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            let countDone = 0;
            snap.forEach(d => {
                const val = d.data(); countDone++;
                const date = val.ts ? val.ts.toDate().toLocaleDateString('hu-HU', {month:'short', day:'numeric'}) : '';
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; font-size:0.9rem;"><span style="font-weight:bold;">${val.task}</span> <span style="color:#888; font-size:0.8rem;">- ${date}</span><br><span style="color:var(--accent); font-weight:bold;">‚úî ${val.user}</span></div>`;
            });
            document.getElementById('stat-done').innerText = countDone;
        });
    }

    // --- 4. OKOS GENER√ÅL√ÅS LOGIKA (GOOGLE NAPT√ÅR ST√çLUS) ---
    async function checkAndGenerateDaily() {
        if(state.tasks.length === 0) return;
        const ref = db.collection('families').doc(state.famId).collection('daily').doc(state.todayStr);
        
        try {
            const doc = await ref.get();
            if(!doc.exists) {
                // Gener√°l√°s: V√©gigmegy√ºnk a feladatokon √©s megn√©zz√ºk, MA esed√©kes-e
                let items = [];
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=V, 1=H...
                const dateNum = today.getDate(); // 1-31

                state.tasks.forEach(t => {
                    let isDue = false;

                    if (t.freqType === 'daily') {
                        // Napi/Heti: ha be van pip√°lva a mai nap
                        if (t.days && t.days.includes(dayOfWeek)) isDue = true;
                        // Ha nincs nap megadva, akkor minden nap (r√©gi logika)
                        if (!t.days || t.days.length === 0) isDue = true; 
                    } 
                    else if (t.freqType === 'monthly_date') {
                        // Fix nap: pl. minden h√≥nap 12. napj√°n
                        if (dateNum == t.monthDay) isDue = true;
                    }
                    else if (t.freqType === 'monthly_pos') {
                        // Poz√≠ci√≥: pl. Els≈ë H√©tf≈ë
                        // 1. Stimmel a nap neve? (pl. H√©tf≈ë)
                        if (dayOfWeek == t.posDay) {
                             // 2. H√°nyadik ilyen nap ez a h√≥napban?
                             // Pl. 1-7 k√∂z√∂tt az 1., 8-14 k√∂z√∂tt a 2.
                             const weekNum = Math.ceil(dateNum / 7);
                             if (weekNum == t.posNum) isDue = true;
                             
                             // Utols√≥ kezel√©se (pl. Utols√≥ p√©ntek)
                             if (t.posNum == -1) {
                                 // Megn√©zz√ºk, van-e m√©g egy ilyen nap a h√≥napban
                                 const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
                                 if (dateNum + 7 > daysInMonth) isDue = true;
                             }
                        }
                    }

                    if (isDue) {
                        items.push({
                            taskId: t.id,
                            name: t.name,
                            cat: t.cat || 'Egy√©b',
                            status: 'todo',
                            desc: describeFreq(t),
                            plannedBy: null,
                            plannedTime: null
                        });
                    }
                });
                await ref.set({ items });
            }
        } catch(e) { console.error(e); }
    }
    
    function describeFreq(t) {
        if(t.freqType === 'monthly_date') return `üìÖ Havi ${t.monthDay}. napj√°n`;
        if(t.freqType === 'monthly_pos') return `üìÖ Havi ism√©tl≈ëd≈ë`;
        return '';
    }

    function renderToday() {
        const list = document.getElementById('task-list'); list.innerHTML = '';
        let done = 0;
        state.daily.forEach((item, idx) => {
            if(item.status === 'done') done++;
            let statusClass = item.status === 'done' ? 'status-done' : (item.plannedBy ? 'status-planned' : 'status-todo');
            let planInfo = item.plannedBy ? `<div class="plan-info">‚úã ${item.plannedBy} v√°llalta ${item.plannedTime ? 'ekkora: '+item.plannedTime : ''}</div>` : '';
            let btns = item.status !== 'done' ? `<div class="btn-row"><button class="btn-plan" onclick="planTask(${idx})">${item.plannedBy?'M√≥dos√≠t':'‚úã V√°llalom'}</button><button class="btn-done" onclick="finishTask(${idx})">‚úî K√©sz</button></div>` : `<div style="margin-top:10px; color:var(--accent); font-weight:bold;">‚úÖ Elv√©gezte: ${item.doneBy}</div>`;
            
            list.innerHTML += `<div class="card ${statusClass}"><div class="task-header"><div><div class="task-cat">${item.cat}</div><div class="task-name">${item.name}</div><div class="task-detail">${item.desc || ''}</div></div></div>${planInfo}${btns}</div>`;
        });
        const pct = state.daily.length > 0 ? (done / state.daily.length) * 100 : 0;
        document.getElementById('daily-progress').style.width = pct + "%";
        document.getElementById('empty-msg').style.display = (state.daily.length > 0 && done === state.daily.length) ? 'block' : 'none';
        document.getElementById('stat-total').innerText = state.daily.length;
    }

    // --- 5. INTERAKCI√ìK ---
    function planTask(idx) {
        const t = prompt("Mikorra?", "De."); if(t===null) return;
        state.daily[idx].plannedBy = state.user; state.daily[idx].plannedTime = t;
        saveDaily();
    }
    function finishTask(idx) {
        state.daily[idx].status = 'done'; state.daily[idx].doneBy = state.user;
        saveDaily();
        db.collection('families').doc(state.famId).collection('history').add({ task: state.daily[idx].name, user: state.user, ts: firebase.firestore.FieldValue.serverTimestamp() });
    }
    function saveDaily() { db.collection('families').doc(state.famId).collection('daily').doc(state.todayStr).update({ items: state.daily }); }

    // --- 6. BE√ÅLL√çT√ÅSOK LOGIKA ---
    function renderFreqOptions() {
        const type = document.getElementById('freq-type').value;
        document.getElementById('opt-daily').style.display = (type === 'daily') ? 'block' : 'none';
        document.getElementById('opt-monthly-date').style.display = (type === 'monthly_date') ? 'block' : 'none';
        document.getElementById('opt-monthly-pos').style.display = (type === 'monthly_pos') ? 'block' : 'none';
    }
    
    function toggleDay(el, d) {
        el.classList.toggle('selected');
    }

    function addNewTask() {
        const name = document.getElementById('new-name').value;
        const cat = document.getElementById('new-cat').value.trim();
        const type = document.getElementById('freq-type').value;
        
        if(!name) return alert("N√©v k√∂telez≈ë!");

        let taskObj = { name, cat, freqType: type };

        if (type === 'daily') {
            let days = [];
            document.querySelectorAll('.day-btn.selected').forEach(el => {
                const txt = el.innerText;
                if(txt=='V') days.push(0); if(txt=='H') days.push(1); if(txt=='K') days.push(2);
                if(txt=='Sz') days.push(3); if(txt=='Cs') days.push(4); if(txt=='P') days.push(5); if(txt=='Szo') days.push(6); // Szombat jav√≠tva
            });
            if(days.length === 0) return alert("V√°lassz legal√°bb egy napot!");
            taskObj.days = days;
        } 
        else if (type === 'monthly_date') {
            taskObj.monthDay = parseInt(document.getElementById('month-day-fix').value);
        }
        else if (type === 'monthly_pos') {
            taskObj.posNum = parseInt(document.getElementById('month-pos-num').value);
            taskObj.posDay = parseInt(document.getElementById('month-pos-day').value);
        }

        // Kateg√≥ria ment√©s
        if(cat && !state.categories.includes(cat)) {
            const newCats = [...state.categories, cat].sort();
            db.collection('families').doc(state.famId).collection('meta').doc('settings').update({ categories: newCats });
        }

        db.collection('families').doc(state.famId).collection('tasks').add(taskObj).then(() => {
            alert("Siker!");
            document.getElementById('new-name').value = '';
            // Reset UI
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
        });
    }

    function renderCategoryChips() {
        const c = document.getElementById('cat-chips'); c.innerHTML = '';
        state.categories.forEach(cat => c.innerHTML += `<div class="chip" onclick="document.getElementById('new-cat').value='${cat}'">${cat} <span class="chip-del" onclick="deleteCat('${cat}', event)">‚úñ</span></div>`);
    }
    function deleteCat(cat, e) {
        e.stopPropagation();
        if(confirm("T√∂rl√∂d?")) {
            const newCats = state.categories.filter(c => c !== cat);
            db.collection('families').doc(state.famId).collection('meta').doc('settings').update({ categories: newCats });
        }
    }
    function renderManageList() {
        const div = document.getElementById('manage-list'); div.innerHTML = '';
        state.tasks.forEach(t => {
            let info = '';
            if(t.freqType === 'daily') info = 'Napi/Heti';
            if(t.freqType === 'monthly_date') info = `Havi ${t.monthDay}. nap`;
            if(t.freqType === 'monthly_pos') info = `Havi minta`;
            div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><div class="task-name">${t.name}</div><div class="task-detail">${t.cat} | ${info}</div></div><button class="btn-danger" style="flex:0; padding:5px 12px;" onclick="if(confirm('T√∂rl√∂d?')) db.collection('families').doc(state.famId).collection('tasks').doc('${t.id}').delete()">T√∂rl√©s</button></div>`;
        });
    }

    window.switchTab = function(id, el) {
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
    }
</script>
</body>
</html>
