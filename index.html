<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Csal√°di Feladatok</title>
    
    <style>
        :root { --main: #6c5ce7; --accent: #00cec9; --bg: #dfe6e9; --danger: #ff7675; --text: #2d3436; --warn: #fdcb6e; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 20px; overflow-y: auto; }
        .login-box { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .login-box label { font-size: 0.8rem; color: #888; display: block; text-align: left; margin-top: 10px; }
        
        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top: 0; z-index:100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--text); font-weight: 800; }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .lang-btn { background: #eee; border: none; padding: 5px 10px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; }

        .pantry-id-badge { 
            background: var(--main); color: white; font-family: monospace; font-size: 0.75rem; 
            padding: 4px 8px; border-radius: 6px; font-weight: bold; cursor: pointer; display: inline-block;
        }

        .sync-badge { font-size: 0.7rem; background: #eee; padding: 3px 8px; border-radius: 10px; color: #555; display: inline-block; margin-left: 5px;}
        .sync-badge.active { background: #55efc4; color: #006266; }
        
        /* LAYOUT */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; animation: fadein 0.3s; }
        .tab-content.active { display: block; }

        /* K√ÅRTY√ÅK */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); border-left: 5px solid #ccc; position: relative; }
        .status-todo { border-left-color: var(--warn); }
        .status-done { border-left-color: #00b894; background: #f0fff4; opacity: 0.8; }
        .status-skipped { border-left-color: #b2bec3; opacity: 0.6; filter: grayscale(100%); }

        .task-header { display: flex; justify-content: space-between; }
        .task-name { font-size: 1.1rem; font-weight: 700; color: #2d3436; }
        
        /* GOMBOK */
        .btn-primary { background: var(--main); color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-edit-mode { background: var(--warn); color: #333; }
        .btn-secondary { background: #0984e3; color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        button { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 0.9rem; transition: 0.2s; }
        .btn-done { background: #00b894; color: white; flex: 2; }
        .btn-skip { background: white; border: 1px solid #dfe6e9; color: #b2bec3; flex: 0.5; }
        .btn-danger { background: var(--danger); color: white; width: 100%; }
        .btn-icon { flex: 0; padding: 5px 12px; font-size: 1rem; margin-left: 5px; }

        /* QR CODE BOX */
        .qr-box { text-align: center; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px dashed #ccc; }
        .qr-box img { max-width: 150px; height: auto; }

        /* INPUTOK - FRISS√çTVE: input[type="date"] hozz√°adva */
        select, input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: white; font-size: 1rem; font-family: inherit; }
        
        .week-selector { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 15px; }
        .day-btn { padding: 10px 0; flex: 1; text-align: center; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .day-btn.selected { background: var(--main); color: white; border-color: var(--main); }

        .date-nav { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .nav-arrow { background: white; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .chip { background: #eee; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; }
        
        .version-tag { text-align: center; font-size: 0.7rem; color: #aaa; margin-top: 30px; }

        /* NAVBAR */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; display: flex; height: 70px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #b2bec3; font-size: 0.75rem; }
        .nav-item.active { color: var(--main); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }

        @keyframes fadein { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--main); margin-top:0;" data-i18n="app_title">‚òÅÔ∏è Csal√°di Feladatok</h2>
        <p style="font-size:0.9rem; color:#666;" data-i18n="login_subtitle">Egy k√≥d az eg√©sz csal√°dnak.</p>
        
        <label data-i18n="your_name">Te neved</label>
        <input type="text" id="user-name" placeholder="...">
        
        <label>Pantry ID</label>
        <input type="text" id="pantry-id" placeholder="ID...">
        
        <div style="font-size:0.75rem; color:#888; margin-bottom:15px; line-height:1.4;">
            <span data-i18n="no_code">M√©g nincs k√≥dod?</span> <a href="https://getpantry.cloud/" target="_blank" style="color:var(--main)">GetPantry</a>.<br>
        </div>

        <button class="btn-primary" onclick="login()" data-i18n="btn_login">Bel√©p√©s</button>
    </div>
</div>

<div id="app" style="display:none;">
    <header>
        <div>
            <div style="font-size:0.7rem; color:#666;" id="display-user-header"></div>
            <h1 style="margin-top:0;" data-i18n="app_title">Csal√°di Feladatok</h1>
        </div>
        <div class="header-controls">
            <button class="lang-btn" onclick="toggleLanguage()" id="lang-icon">HU</button>
            <div class="sync-badge" id="sync-status">Offline</div>
        </div>
    </header>

    <div class="container">
        
        <div id="tab-today" class="tab-content active">
            <div class="date-nav">
                <button class="nav-arrow" onclick="changeDay(-1)">‚ùÆ</button>
                <div id="today-date" style="font-weight:bold; width:180px; text-align:center;"></div>
                <button class="nav-arrow" onclick="changeDay(1)">‚ùØ</button>
            </div>
            
            <div id="task-list"></div>
            
            <div id="empty-msg" style="text-align:center; color:#aaa; margin-top:60px; display:none;">
                <div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div>
                <p data-i18n="all_done">M√°ra minden k√©sz!</p>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card" id="edit-card">
                <h3 style="margin-top:0;">
                    <span id="form-title" data-i18n="new_task">‚ûï √öj feladat</span>
                    <button id="cancel-edit" onclick="cancelEdit()" style="display:none; float:right; font-size:0.8rem; background:#ccc; padding:5px;">‚ùå</button>
                </h3>
                
                <input type="text" id="new-name" placeholder="Feladat neve (HU)">
                <input type="text" id="new-name-en" placeholder="Task name (EN - Opcion√°lis)" style="border-color: #74b9ff; background:#f0f8ff;">
                
                <input type="text" id="new-cat" placeholder="Kateg√≥ria (pl. Konyha)" oninput="filterCats()">
                <div id="cat-chips" class="chip-container"></div>

                <label data-i18n="freq_label">Gyakoris√°g:</label>
                <select id="freq-type" onchange="renderFreqOptions()">
                    <option value="every_day" data-i18n="freq_every_day">Minden nap</option>
                    <option value="weekly_days" data-i18n="freq_weekly_days">Heti konkr√©t napok</option>
                    <option value="interval_week" data-i18n="freq_interval_week">Ciklikus (Hetente)</option>
                    <option value="interval_month" data-i18n="freq_interval_month">Ciklikus (Havonta)</option>
                    <option value="monthly_fix" data-i18n="freq_monthly_fix">Havi fix napon</option>
                </select>

                <label data-i18n="start_date_label" style="font-size: 0.85rem; color:#666; margin-bottom: 5px; display:block;">Kezd≈ë d√°tum (sz√°m√≠t√°shoz):</label>
                <input type="date" id="start-date-picker">
                <div id="opt-weekly-days" style="display:none;">
                    <div class="week-selector">
                        <div class="day-btn" onclick="toggleDay(this)">H</div>
                        <div class="day-btn" onclick="toggleDay(this)">K</div>
                        <div class="day-btn" onclick="toggleDay(this)">Sz</div>
                        <div class="day-btn" onclick="toggleDay(this)">Cs</div>
                        <div class="day-btn" onclick="toggleDay(this)">P</div>
                        <div class="day-btn" onclick="toggleDay(this)">Sz</div>
                        <div class="day-btn" onclick="toggleDay(this)">V</div>
                    </div>
                </div>
                <div id="opt-interval-week" style="display:none;">
                    <label data-i18n="every_x_weeks">Minden X. h√©ten:</label>
                    <input type="number" id="interval-week-num" value="1" min="1">
                </div>
                <div id="opt-interval-month" style="display:none;">
                    <label data-i18n="every_y_months">Minden Y. h√≥napban:</label>
                    <input type="number" id="interval-month-num" value="1" min="1">
                </div>
                <div id="opt-monthly-fix" style="display:none;">
                    <label data-i18n="which_day">H√°nyadik√°n:</label>
                    <input type="number" id="month-day-fix" min="1" max="31" value="1">
                </div>

                <button id="btn-save-task" class="btn-primary" onclick="saveTaskFromForm()" data-i18n="btn_save">Ment√©s</button>
            </div>
            
            <h3 data-i18n="manage_tasks">Feladatok kezel√©se</h3>
            <div id="manage-list"></div>
        </div>

        <div id="tab-info" class="tab-content">
            
            <div class="card" style="border-left-color: var(--main);">
                <h3 style="margin-top:0;" data-i18n="share_title">üîó Csal√°d megh√≠v√°sa</h3>
                <p data-i18n="share_desc">Hogy a t√∂bbiek is l√°ss√°k ezt a feladatnapl√≥t, ugyanazt a k√≥dot kell haszn√°lniuk.</p>
                
                <button class="btn-secondary" onclick="shareAccess()" data-i18n="btn_send_code">üì§ K√≥d k√ºld√©se</button>
                
                <div class="qr-box">
                    <img id="qr-image" src="" alt="QR K√≥d">
                </div>
            </div>

            <div class="card">
                <h3 data-i18n="settings_title">Be√°ll√≠t√°sok</h3>
                <p><b>N√©v:</b> <span id="display-user"></span></p>
                <div style="font-family:monospace; margin-bottom:10px; word-break:break-all;">
                    <b>ID:</b> <span id="display-pantry-id"></span>
                </div>

                <button class="btn-secondary" onclick="fetchData()" style="margin-bottom:10px;">üîÑ <span data-i18n="force_sync">Szinkroniz√°l√°s most</span></button>
                <button class="btn-danger" onclick="logout()" data-i18n="btn_logout">üö™ Kil√©p√©s</button>
            </div>

            <div class="card">
                <h3 data-i18n="help_title">Haszn√°lati √ötmutat√≥</h3>
                <div style="font-size:0.9rem; line-height:1.5; color:#444;">
                    <p data-i18n="help_1"><b>1. Napl√≥:</b> Itt l√°tod a mai teend≈ëket. Ha k√©sz vagy, nyomj a 'K√©sz'-re. Ha ma nem csin√°lod meg, a 'Tilt√°s' jellel √°tugorhatod.</p>
                    <p data-i18n="help_2"><b>2. √öj/Szerkeszt√©s:</b> Itt adhatsz hozz√° √∫j feladatokat vagy m√≥dos√≠thatod a r√©gieket. A ceruza ikonnal t√∂ltsd be szerkeszt√©sre.</p>
                    <p data-i18n="help_3"><b>3. Szinkron:</b> Az adatok automatikusan ment≈ëdnek a felh≈ëbe. Ha nem l√°tsz valamit, nyomj a fenti 'Szinkroniz√°l√°s most' gombra.</p>
                    <p data-i18n="help_4"><b>4. Ford√≠t√°s:</b> Megadhatsz angol nevet is a feladatnak. A 'Kezd≈ë d√°tum'-n√°l √°ll√≠thatod be, mikort√≥l sz√°mol√≥djon a ciklus.</p>
                </div>
            </div>

            <div class="version-tag">Verzi√≥: v0.95 (Date Picker)</div>
        </div>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('tab-today', this)"><span class="nav-icon">üìÖ</span> <span data-i18n="nav_today">Ma</span></div>
    <div class="nav-item" onclick="switchTab('tab-settings', this)"><span class="nav-icon">‚öôÔ∏è</span> <span data-i18n="nav_new">Be√°ll√≠t</span></div>
    <div class="nav-item" onclick="switchTab('tab-info', this)"><span class="nav-icon">üîó</span> <span data-i18n="nav_info">Inf√≥</span></div>
</nav>

<script>
    // --- AUTOMATA KATEG√ìRIA FORD√çT√ì ---
    const catDictionary = {
        "Konyha": "Kitchen", "F√ºrd≈ëszoba": "Bathroom", "F√ºrd≈ë": "Bathroom", 
        "Nappali": "Living Room", "H√°l√≥": "Bedroom", "H√°l√≥szoba": "Bedroom",
        "Kert": "Garden", "Udvar": "Yard", "Gar√°zs": "Garage", 
        "Bev√°s√°rl√°s": "Shopping", "Egy√©b": "Other", "Munka": "Work",
        "Takar√≠t√°s": "Cleaning", "Mos√°s": "Laundry"
    };

    // --- NYELVI BE√ÅLL√çT√ÅSOK ---
    const i18n = {
        hu: {
            app_title: "Csal√°di Feladatok", login_subtitle: "Egy k√≥d az eg√©sz csal√°dnak.", your_name: "Te neved", no_code: "M√©g nincs k√≥dod?", btn_login: "Bel√©p√©s",
            all_done: "M√°ra minden k√©sz!", new_task: "‚ûï √öj feladat", edit_task: "‚úèÔ∏è Szerkeszt√©s", freq_label: "Gyakoris√°g:",
            freq_every_day: "Minden nap", freq_weekly_days: "Heti konkr√©t napok", freq_interval_week: "Ciklikus (Hetente)", freq_interval_month: "Ciklikus (Havonta)", freq_monthly_fix: "Havi fix napon",
            every_x_weeks: "Minden X. h√©ten:", every_y_months: "Minden Y. h√≥napban:", which_day: "H√°nyadik√°n:", btn_save: "Ment√©s", btn_update: "M√≥dos√≠t√°s",
            manage_tasks: "Feladatok kezel√©se", share_title: "üîó Csal√°d megh√≠v√°sa", share_desc: "Hogy a t√∂bbiek is l√°ss√°k ezt a napl√≥t, ugyanazt a k√≥dot kell haszn√°lniuk.",
            btn_send_code: "üì§ K√≥d k√ºld√©se", settings_title: "Saj√°t adatok", force_sync: "Szinkroniz√°l√°s most", btn_logout: "üö™ Kil√©p√©s",
            help_title: "Haszn√°lati √ötmutat√≥", help_1: "<b>1. Napl√≥:</b> Itt l√°tod a mai teend≈ëket.", help_2: "<b>2. Szerkeszt√©s:</b> A list√°ban a ceruza ikonnal szerkeszthetsz.", help_3: "<b>3. Szinkron:</b> Automatikus, de manu√°lisan is friss√≠thetsz.", help_4: "<b>4. D√°tum:</b> Be√°ll√≠thatod a kezd≈ë d√°tumot a ciklusokhoz.",
            nav_today: "Ma", nav_new: "Kezel√©s", nav_info: "Inf√≥", confirm_del: "Biztosan t√∂rl√∂d? A kor√°bbi teljes√≠t√©sek is t√∂rl≈ëdnek!",
            task_saved: "Sikeres ment√©s!", task_deleted: "T√∂r√∂lve.",
            start_date_label: "Kezd≈ë d√°tum (sz√°m√≠t√°shoz):"
        },
        en: {
            app_title: "Family Tasks", login_subtitle: "One code for the whole family.", your_name: "Your Name", no_code: "No code yet?", btn_login: "Login",
            all_done: "All done for today!", new_task: "‚ûï New Task", edit_task: "‚úèÔ∏è Edit Task", freq_label: "Frequency:",
            freq_every_day: "Every day", freq_weekly_days: "Specific weekdays", freq_interval_week: "Cyclic (Weeks)", freq_interval_month: "Cyclic (Months)", freq_monthly_fix: "Monthly fix date",
            every_x_weeks: "Every X weeks:", every_y_months: "Every Y months:", which_day: "Day of month:", btn_save: "Save", btn_update: "Update",
            manage_tasks: "Manage Tasks", share_title: "üîó Invite Family", share_desc: "Share this code so others can access the diary.",
            btn_send_code: "üì§ Send Code", settings_title: "My Data", force_sync: "Sync Now", btn_logout: "üö™ Logout",
            help_title: "User Guide", help_1: "<b>1. Diary:</b> View today's tasks here.", help_2: "<b>2. Edit:</b> Use the pencil icon to edit tasks.", help_3: "<b>3. Sync:</b> Automatic, but you can force sync here.", help_4: "<b>4. Date:</b> Set start date for cyclic calculations.",
            nav_today: "Today", nav_new: "Manage", nav_info: "Info", confirm_del: "Delete task? History will also be deleted!",
            task_saved: "Saved successfully!", task_deleted: "Deleted.",
            start_date_label: "Start Date (Calculation):"
        }
    };

    let currentLang = localStorage.getItem('app_lang') || (navigator.language.startsWith('hu') ? 'hu' : 'en');
    
    function toggleLanguage() {
        currentLang = currentLang === 'hu' ? 'en' : 'hu';
        localStorage.setItem('app_lang', currentLang);
        applyLanguage();
        renderToday(); 
        renderManageList();
    }

    function applyLanguage() {
        document.getElementById('lang-icon').innerText = currentLang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(i18n[currentLang][key]) {
                if(el.tagName === 'INPUT') el.placeholder = i18n[currentLang][key];
                else el.innerHTML = i18n[currentLang][key];
            }
        });
        updateDateDisplay();
    }

    function getTaskName(t) {
        if (typeof t.name === 'object') {
            return (currentLang === 'en' && t.name.en) ? t.name.en : t.name.hu;
        }
        return t.name; 
    }

    function getCatName(cat) {
        if (!cat) return "";
        if (currentLang === 'en' && catDictionary[cat]) return catDictionary[cat];
        return cat;
    }

    // --- KONFIGUR√ÅCI√ì ---
    const PANTRY_BASE = "https://getpantry.cloud/apiv1/pantry/";
    const BASKET_NAME = "MyFamilyTasks_v2"; 

    // --- √ÅLLAPOT ---
    let state = {
        user: localStorage.getItem('pantry_user') || '',
        pantryId: localStorage.getItem('pantry_id') || '',
        tasks: [], dailyLog: {}, categories: [], currentDateObj: new Date()
    };
    let editingTaskId = null; 

    // --- INIT ---
    const urlParams = new URLSearchParams(window.location.search);
    const idFromUrl = urlParams.get('id');
    if(idFromUrl) {
        document.getElementById('pantry-id').value = idFromUrl;
        if(state.user) login(); 
    }

    if(state.user && state.pantryId) {
        document.getElementById('user-name').value = state.user;
        document.getElementById('pantry-id').value = state.pantryId;
        startApp();
    }
    
    applyLanguage();

    function login() {
        const u = document.getElementById('user-name').value.trim();
        const pid = document.getElementById('pantry-id').value.trim();
        if(!u || !pid) return alert("Required!");
        
        state.user = u;
        state.pantryId = pid;
        localStorage.setItem('pantry_user', u);
        localStorage.setItem('pantry_id', pid);
        startApp();
    }

    function logout() {
        if(confirm("Exit?")) {
            localStorage.clear();
            window.location.href = window.location.pathname; 
        }
    }

    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        document.getElementById('display-user').innerText = state.user;
        document.getElementById('display-user-header').innerText = "üë§ " + state.user;
        document.getElementById('display-pantry-id').innerText = state.pantryId;
        
        const currentUrl = window.location.href.split('?')[0];
        const isWeb = currentUrl.startsWith('http');
        const qrData = isWeb ? `${currentUrl}?id=${state.pantryId}` : state.pantryId;
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;

        // Be√°ll√≠tjuk a d√°tumv√°laszt√≥t a mai napra alap√©rtelmezetten
        document.getElementById('start-date-picker').value = new Date().toISOString().split('T')[0];

        updateDateDisplay();
        fetchData();
        setInterval(fetchData, 15000); 
    }

    // --- ADATKEZEL√âS ---
    async function fetchData() {
        updateSyncStatus('syncing');
        const url = `${PANTRY_BASE}${state.pantryId}/basket/${BASKET_NAME}`;
        try {
            const res = await fetch(url);
            if (!res.ok) {
                if(res.status === 400 || res.status === 404) { 
                    console.log("Creating new basket...");
                    await saveData(true); return; 
                }
                throw new Error(res.status);
            }
            const data = await res.json();
            state.tasks = data.tasks || [];
            state.dailyLog = data.dailyLog || {};
            state.categories = data.categories || [];
            renderManageList(); renderToday(); updateSyncStatus('online');
        } catch (e) { console.error(e); updateSyncStatus('error'); }
    }

    async function saveData(isInit = false) {
        updateSyncStatus('syncing');
        const url = `${PANTRY_BASE}${state.pantryId}/basket/${BASKET_NAME}`;
        const payload = { tasks: state.tasks, dailyLog: state.dailyLog, categories: state.categories, lastUpdate: Date.now() };
        try {
            await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            updateSyncStatus('online');
            if(!isInit) renderToday();
        } catch(e) { updateSyncStatus('error'); }
    }

    function updateSyncStatus(s) {
        const el = document.getElementById('sync-status');
        if(s==='syncing') { el.innerText = '‚åõ'; el.className = 'sync-badge'; }
        else if(s==='online') { el.innerText = '‚òÅÔ∏è OK'; el.className = 'sync-badge active'; }
        else { el.innerText = '‚ö†Ô∏è Err'; el.style.background='red'; el.style.color='white'; }
    }

    // --- TASK LOGIKA ---
    function saveTaskFromForm() {
        const nameHu = document.getElementById('new-name').value;
        const nameEn = document.getElementById('new-name-en').value;
        
        if(!nameHu) return alert("Name (HU) required!");
        const cat = document.getElementById('new-cat').value;
        const type = document.getElementById('freq-type').value;
        
        // D√°tum kiolvas√°sa a napt√°rb√≥l
        const datePickerVal = document.getElementById('start-date-picker').value;
        const finalStartDate = datePickerVal ? new Date(datePickerVal).toISOString() : new Date().toISOString();

        let finalName = nameEn ? { hu: nameHu, en: nameEn } : nameHu;

        let t = { 
            id: editingTaskId || 't_'+Date.now(), 
            name: finalName, 
            cat, 
            freqType: type, 
            startDate: finalStartDate 
        };
        
        if(type==='weekly_days') {
            let days = [];
            const dayButtons = document.querySelectorAll('.week-selector .day-btn');
            const dayMap = [1, 2, 3, 4, 5, 6, 0];
            dayButtons.forEach((btn, index) => { if(btn.classList.contains('selected')) days.push(dayMap[index]); });
            if(days.length === 0) return alert("Select days!");
            t.days = days;
        }
        else if(type==='interval_week') t.interval = parseInt(document.getElementById('interval-week-num').value);
        else if(type==='interval_month') t.interval = parseInt(document.getElementById('interval-month-num').value);
        else if(type==='monthly_fix') t.monthDay = parseInt(document.getElementById('month-day-fix').value);

        if(cat && !state.categories.includes(cat)) state.categories.push(cat);

        if (editingTaskId) {
            const idx = state.tasks.findIndex(x => x.id === editingTaskId);
            if(idx > -1) state.tasks[idx] = t;
        } else {
            state.tasks.push(t);
        }
        
        saveData(); 
        alert(i18n[currentLang].task_saved);
        cancelEdit(); 
        switchTab('tab-today');
    }

    function loadTaskForEdit(id) {
        const t = state.tasks.find(x => x.id === id);
        if(!t) return;
        
        editingTaskId = id;
        document.getElementById('form-title').innerText = i18n[currentLang].edit_task;
        document.getElementById('btn-save-task').innerText = i18n[currentLang].btn_update;
        document.getElementById('btn-save-task').classList.add('btn-edit-mode');
        document.getElementById('cancel-edit').style.display = 'block';

        if (typeof t.name === 'object') {
            document.getElementById('new-name').value = t.name.hu;
            document.getElementById('new-name-en').value = t.name.en || '';
        } else {
            document.getElementById('new-name').value = t.name;
            document.getElementById('new-name-en').value = '';
        }

        document.getElementById('new-cat').value = t.cat;
        document.getElementById('freq-type').value = t.freqType;
        
        // D√°tum bet√∂lt√©se a picker-be
        if(t.startDate) {
            document.getElementById('start-date-picker').value = t.startDate.split('T')[0];
        }

        renderFreqOptions();

        if(t.freqType === 'weekly_days') {
            document.querySelectorAll('.week-selector .day-btn').forEach(b => b.classList.remove('selected'));
            const mapRev = {1:0, 2:1, 3:2, 4:3, 5:4, 6:5, 0:6};
            const btns = document.querySelectorAll('.week-selector .day-btn');
            t.days.forEach(d => { if(mapRev[d] !== undefined) btns[mapRev[d]].classList.add('selected'); });
        }
        else if(t.freqType === 'interval_week') document.getElementById('interval-week-num').value = t.interval;
        else if(t.freqType === 'interval_month') document.getElementById('interval-month-num').value = t.interval;
        else if(t.freqType === 'monthly_fix') document.getElementById('month-day-fix').value = t.monthDay;

        window.scrollTo(0,0);
    }

    function cancelEdit() {
        editingTaskId = null;
        document.getElementById('form-title').innerText = i18n[currentLang].new_task;
        document.getElementById('btn-save-task').innerText = i18n[currentLang].btn_save;
        document.getElementById('btn-save-task').classList.remove('btn-edit-mode');
        document.getElementById('cancel-edit').style.display = 'none';
        document.getElementById('new-name').value = '';
        document.getElementById('new-name-en').value = '';
        
        // D√°tum vissza√°ll√≠t√°sa m√°ra
        document.getElementById('start-date-picker').value = new Date().toISOString().split('T')[0];
        
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('selected'));
    }

    function deleteTask(id) { 
        if(confirm(i18n[currentLang].confirm_del)) { 
            state.tasks = state.tasks.filter(x => x.id !== id);
            Object.keys(state.dailyLog).forEach(dayKey => {
                state.dailyLog[dayKey] = state.dailyLog[dayKey].filter(item => item.taskId !== id);
                if(state.dailyLog[dayKey].length === 0) delete state.dailyLog[dayKey];
            });
            saveData(); 
            renderManageList();
            if(editingTaskId === id) cancelEdit();
        } 
    }

    function isTaskDue(t, dateToCheck) {
        const d = dateToCheck.getDate(); 
        const day = dateToCheck.getDay();
        const m = dateToCheck.getMonth();
        const y = dateToCheck.getFullYear();
        
        if(t.freqType === 'every_day') return true;
        if(t.freqType === 'weekly_days') return t.days ? t.days.includes(day) : true;
        if(t.freqType === 'monthly_fix') return d == t.monthDay;
        
        const startDate = new Date(t.startDate);
        startDate.setHours(0,0,0,0);
        const currDate = new Date(dateToCheck);
        currDate.setHours(0,0,0,0);

        if(t.freqType === 'interval_week') {
             const diffDays = Math.floor((currDate - startDate) / (1000 * 60 * 60 * 24));
             return diffDays >= 0 && diffDays % (t.interval * 7) === 0;
        }
        if(t.freqType === 'interval_month') {
            const startDay = startDate.getDate();
            if (d !== startDay) return false; 
            const monthDiff = (y - startDate.getFullYear()) * 12 + (m - startDate.getMonth());
            return monthDiff >= 0 && monthDiff % t.interval === 0;
        }
        return false;
    }

    // --- UI RENDER ---
    function renderToday() {
        const list = document.getElementById('task-list'); list.innerHTML = '';
        const todayStr = state.currentDateObj.toISOString().split('T')[0];
        let dailyItems = state.dailyLog[todayStr] || [];
        
        state.tasks.forEach(t => {
            if (!dailyItems.some(i => i.taskId === t.id) && isTaskDue(t, state.currentDateObj)) {
                dailyItems.push({ taskId: t.id, status: 'todo' });
            }
        });
        
        let allDone = true;
        if(dailyItems.length === 0) allDone = false;

        dailyItems.forEach((item, idx) => {
            const taskDef = state.tasks.find(x => x.id === item.taskId);
            if(!taskDef) return; 

            const displayName = getTaskName(taskDef);
            const displayCat = getCatName(taskDef.cat);

            if(item.status === 'todo') allDone = false;
            let cls = item.status === 'done' ? 'status-done' : (item.status === 'skipped' ? 'status-skipped' : 'status-todo');
            let btns = item.status === 'todo' ? `
                <div class="btn-row">
                    <button class="btn-skip" onclick="updateStatus('${todayStr}',${idx},'skipped')">üö´</button>
                    <button class="btn-done" onclick="updateStatus('${todayStr}',${idx},'done')">OK</button>
                </div>` : (item.status==='done' ? `<div style="margin-top:5px; color:#00b894; font-weight:bold;">‚úÖ OK</div>` : '');
            
            list.innerHTML += `<div class="card ${cls}"><div class="task-header"><div><b>${displayName}</b><br><small>${displayCat}</small></div></div>${btns}</div>`;
        });
        document.getElementById('empty-msg').style.display = allDone ? 'block' : 'none';
    }

    function renderManageList() { 
        document.getElementById('manage-list').innerHTML = state.tasks.map(t => {
            const displayName = getTaskName(t);
            const displayCat = getCatName(t.cat);
            return `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;"><b>${displayName}</b><br><small>${displayCat} | ${t.freqType}</small></div> 
                <button class="btn-secondary btn-icon" onclick="loadTaskForEdit('${t.id}')">‚úèÔ∏è</button>
                <button class="btn-danger btn-icon" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
            </div>`
        }).join(''); 
    }
    
    function renderFreqOptions() { 
        const v = document.getElementById('freq-type').value;
        document.getElementById('opt-weekly-days').style.display = v==='weekly_days'?'block':'none';
        document.getElementById('opt-interval-week').style.display = v==='interval_week'?'block':'none';
        document.getElementById('opt-interval-month').style.display = v==='interval_month'?'block':'none';
        document.getElementById('opt-monthly-fix').style.display = v==='monthly_fix'?'block':'none';
    }

    // --- SEG√âDEK ---
    function updateStatus(d,i,s) { 
        if(!state.dailyLog[d]) state.dailyLog[d] = [];
        state.dailyLog[d][i].status = s; 
        renderToday(); 
        saveData(); 
    }
    function changeDay(o) { state.currentDateObj.setDate(state.currentDateObj.getDate()+o); updateDateDisplay(); renderToday(); }
    function updateDateDisplay() { 
        const opts = {weekday:'short', month:'short', day:'numeric'};
        const loc = currentLang === 'hu' ? 'hu-HU' : 'en-US';
        document.getElementById('today-date').innerText = state.currentDateObj.toLocaleDateString(loc, opts); 
    }
    function toggleDay(e) { e.classList.toggle('selected'); }
    function filterCats() { 
        const div = document.getElementById('cat-chips'); div.innerHTML='';
        state.categories.forEach(c => div.innerHTML+=`<div class="chip" onclick="document.getElementById('new-cat').value='${c}'">${c}</div>`);
    }

    async function shareAccess() {
        const currentUrl = window.location.href.split('?')[0];
        const isWeb = currentUrl.startsWith('http');
        const shareData = {
            title: i18n[currentLang].app_title,
            text: `csal√°di feladatnapl√≥: ${state.pantryId}`,
            url: isWeb ? `${currentUrl}?id=${state.pantryId}` : undefined
        };
        try { await navigator.share(shareData); } catch (err) { copyIdToClipboard(); }
    }
    function copyIdToClipboard() {
        navigator.clipboard.writeText(state.pantryId).then(() => alert("Copied!")).catch(()=>prompt("Copy:", state.pantryId));
    }
    
    window.switchTab = function(id, el) { 
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); 
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); 
        if(el) el.classList.add('active');
        else if(id === 'tab-today') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        if(id === 'tab-settings') { renderManageList(); cancelEdit(); }
    }
</script>
</body>
</html>
