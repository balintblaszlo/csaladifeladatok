<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Csal√°di Napl√≥</title>
    
    <style>
        :root { --main: #6c5ce7; --accent: #00cec9; --bg: #dfe6e9; --danger: #ff7675; --text: #2d3436; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; user-select: none; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 20px; overflow-y: auto; }
        .login-box { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .login-box label { font-size: 0.8rem; color: #888; display: block; text-align: left; margin-top: 10px; }
        
        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top:0; z-index:100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--text); font-weight: 800; }
        
        .pantry-id-badge { 
            background: var(--main); color: white; font-family: monospace; font-size: 0.75rem; 
            padding: 4px 8px; border-radius: 6px; font-weight: bold; cursor: pointer;
        }

        .sync-badge { font-size: 0.7rem; background: #eee; padding: 3px 8px; border-radius: 10px; color: #555; }
        .sync-badge.active { background: #55efc4; color: #006266; }
        
        /* LAYOUT */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; animation: fadein 0.3s; }
        .tab-content.active { display: block; }

        /* K√ÅRTY√ÅK */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); border-left: 5px solid #ccc; position: relative; }
        .status-todo { border-left-color: #fdcb6e; }
        .status-done { border-left-color: #00b894; background: #f0fff4; opacity: 0.8; }
        .status-skipped { border-left-color: #b2bec3; opacity: 0.6; filter: grayscale(100%); }

        .task-header { display: flex; justify-content: space-between; }
        .task-name { font-size: 1.1rem; font-weight: 700; color: #2d3436; }
        .task-detail { font-size: 0.8rem; color: #636e72; font-style: italic; margin-top: 4px; }
        
        /* GOMBOK */
        .btn-primary { background: var(--main); color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-secondary { background: #0984e3; color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        button { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 0.9rem; transition: 0.2s; }
        .btn-done { background: #00b894; color: white; flex: 2; }
        .btn-skip { background: white; border: 1px solid #dfe6e9; color: #b2bec3; flex: 0.5; }
        .btn-danger { background: var(--danger); color: white; width: 100%; }

        /* QR CODE BOX */
        .qr-box { text-align: center; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px dashed #ccc; }
        .qr-box img { max-width: 150px; height: auto; }

        /* INPUTOK */
        select, input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: white; font-size: 1rem; }
        
        .week-selector { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 15px; }
        .day-btn { padding: 10px 0; flex: 1; text-align: center; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .day-btn.selected { background: var(--main); color: white; border-color: var(--main); }

        .date-nav { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .nav-arrow { background: white; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .chip { background: #eee; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; }
        
        /* NAVBAR */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; display: flex; height: 70px; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #b2bec3; font-size: 0.75rem; }
        .nav-item.active { color: var(--main); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }

        @keyframes fadein { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--main); margin-top:0;">‚òÅÔ∏è Csal√°di Napl√≥</h2>
        <p style="font-size:0.9rem; color:#666;">Egy k√≥d az eg√©sz csal√°dnak.</p>
        
        <label>Te neved</label>
        <input type="text" id="user-name" placeholder="pl. Anya">
        
        <label>K√∂z√∂s Pantry K√≥d (ID)</label>
        <input type="text" id="pantry-id" placeholder="Illeszd be a k√≥dot ide">
        
        <div style="font-size:0.75rem; color:#888; margin-bottom:15px; line-height:1.4;">
            M√©g nincs k√≥dod? <a href="https://getpantry.cloud/" target="_blank" style="color:var(--main)">K√©rj egyet itt</a>.<br>
            Ha kapt√°l <b>linket</b> vagy <b>QR k√≥dot</b>, haszn√°ld azt!
        </div>

        <button class="btn-primary" onclick="login()">Bel√©p√©s</button>
    </div>
</div>

<div id="app" style="display:none;">
    <header>
        <div style="display:flex; flex-direction:column;">
            <div id="sticky-pantry-id" class="pantry-id-badge" onclick="copyIdToClipboard()">ID M√°sol√°sa üìã</div>
            <h1 style="margin-top:5px;">Napl√≥</h1>
        </div>
        <div class="sync-badge" id="sync-status">Offline</div>
    </header>

    <div class="container">
        
        <div id="tab-today" class="tab-content active">
            <div class="date-nav">
                <button class="nav-arrow" onclick="changeDay(-1)">‚ùÆ</button>
                <div id="today-date" style="font-weight:bold; width:180px; text-align:center;"></div>
                <button class="nav-arrow" onclick="changeDay(1)">‚ùØ</button>
            </div>
            
            <div id="task-list"></div>
            
            <div id="empty-msg" style="text-align:center; color:#aaa; margin-top:60px; display:none;">
                <div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div>
                <p>M√°ra minden k√©sz!</p>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0;">‚ûï √öj feladat</h3>
                
                <input type="text" id="new-name" placeholder="Feladat neve">
                <input type="text" id="new-cat" placeholder="Kateg√≥ria (pl. Konyha)" oninput="filterCats()">
                <div id="cat-chips" class="chip-container"></div>

                <select id="freq-type" onchange="renderFreqOptions()">
                    <option value="every_day">Minden nap</option>
                    <option value="weekly_days">Heti konkr√©t napok</option>
                    <option value="interval_week">Ciklikus (Hetente)</option>
                    <option value="monthly_fix">Havi fix napon</option>
                </select>

                <div id="opt-weekly-days" style="display:none;">
                    <div class="week-selector">
                        <div class="day-btn" onclick="toggleDay(this)">H</div><div class="day-btn" onclick="toggleDay(this)">K</div><div class="day-btn" onclick="toggleDay(this)">Sz</div>
                        <div class="day-btn" onclick="toggleDay(this)">Cs</div><div class="day-btn" onclick="toggleDay(this)">P</div><div class="day-btn" onclick="toggleDay(this)">Sz</div><div class="day-btn" onclick="toggleDay(this)">V</div>
                    </div>
                </div>
                <div id="opt-interval-week" style="display:none;"><label>Minden X. h√©ten:</label><input type="number" id="interval-week-num" value="1" min="1"></div>
                <div id="opt-monthly-fix" style="display:none;"><label>H√°nyadik√°n:</label><input type="number" id="month-day-fix" min="1" max="31" value="1"></div>

                <button class="btn-primary" onclick="addNewTask()">Ment√©s</button>
            </div>
            
            <h3>Feladatok kezel√©se</h3>
            <div id="manage-list"></div>
        </div>

        <div id="tab-info" class="tab-content">
            
            <div class="card" style="border-left-color: var(--main);">
                <h3 style="margin-top:0;">üîó Csal√°d megh√≠v√°sa</h3>
                <p>Hogy a t√∂bbiek is l√°ss√°k ezt a napl√≥t, ugyanazt a k√≥dot kell haszn√°lniuk.</p>
                
                <button class="btn-secondary" onclick="shareAccess()">üì§ K√≥d k√ºld√©se (Messenger/Viber)</button>
                
                <div class="qr-box">
                    <p style="margin:0 0 10px 0; font-size:0.8rem; color:#666;">Mutasd ezt a csal√°dtagodnak:</p>
                    <img id="qr-image" src="" alt="QR K√≥d">
                    <p style="font-size:0.7rem; color:#888; margin-top:5px;">Ha ezt leolvass√°k a kamer√°val, a telefonjuk felaj√°nlja a k√≥d m√°sol√°s√°t.</p>
                </div>
            </div>

            <div class="card">
                <h3>Saj√°t adatok</h3>
                <p><b>N√©v:</b> <span id="display-user"></span></p>
                <p><b>Pantry ID:</b> <span id="display-pantry-id" style="font-family:monospace; font-weight:bold;"></span></p>
                <div style="margin-top: 20px;">
                    <button class="btn-danger" onclick="logout()">üö™ Kil√©p√©s</button>
                </div>
            </div>
        </div>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('tab-today', this)"><span class="nav-icon">üìÖ</span> Ma</div>
    <div class="nav-item" onclick="switchTab('tab-settings', this)"><span class="nav-icon">‚öôÔ∏è</span> √öj</div>
    <div class="nav-item" onclick="switchTab('tab-info', this)"><span class="nav-icon">üîó</span> Inf√≥</div>
</nav>

<script>
    // --- KONFIGUR√ÅCI√ì ---
    const PANTRY_BASE = "https://getpantry.cloud/apiv1/pantry/";
    const BASKET_NAME = "MyFamilyTasks"; 

    // --- √ÅLLAPOT ---
    let state = {
        user: localStorage.getItem('pantry_user') || '',
        pantryId: localStorage.getItem('pantry_id') || '',
        tasks: [], dailyLog: {}, categories: [], currentDateObj: new Date()
    };

    // --- OKOS URL KEZEL√âS (MAGIC LINK) ---
    // Ha a linkben benne van hogy ?id=XXXX, akkor t√∂ltse ki mag√°t√≥l
    const urlParams = new URLSearchParams(window.location.search);
    const idFromUrl = urlParams.get('id');
    if(idFromUrl) {
        document.getElementById('pantry-id').value = idFromUrl;
        if(state.user) login(); // Ha m√°r van neve, l√©pjen is be
    }

    // --- IND√çT√ÅS ---
    if(state.user && state.pantryId) {
        document.getElementById('user-name').value = state.user;
        document.getElementById('pantry-id').value = state.pantryId;
        startApp();
    }

    function login() {
        const u = document.getElementById('user-name').value.trim();
        const pid = document.getElementById('pantry-id').value.trim();
        if(!u || !pid) return alert("N√©v √©s K√≥d k√∂telez≈ë!");
        
        state.user = u;
        state.pantryId = pid;
        localStorage.setItem('pantry_user', u);
        localStorage.setItem('pantry_id', pid);
        
        // Ha nem volt az URL-ben, de most bel√©pett, friss√≠ts√ºk az URL-t hogy k√∂nyvjelz≈ëzhet≈ë legyen (opcion√°lis)
        // const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + pid;
        // window.history.pushState({path:newUrl},'',newUrl);

        startApp();
    }

    function logout() {
        if(confirm("Biztosan kil√©psz?")) {
            localStorage.clear();
            window.location.href = window.location.pathname; // Tiszta √∫jrat√∂lt√©s
        }
    }

    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        document.getElementById('display-user').innerText = state.user;
        document.getElementById('display-pantry-id').innerText = state.pantryId;
        document.getElementById('sticky-pantry-id').innerText = "üìã ID: " + state.pantryId.substring(0,6) + "...";
        
        // QR K√≥d gener√°l√°sa (API-val)
        // Ha weben van az oldal, akkor a teljes linket k√≥doljuk bele. Ha nincs, akkor csak a nyers ID-t.
        const currentUrl = window.location.href.split('?')[0];
        const isWeb = currentUrl.startsWith('http');
        const qrData = isWeb ? `${currentUrl}?id=${state.pantryId}` : state.pantryId;
        
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;

        updateDateDisplay();
        fetchData();
        setInterval(fetchData, 8000); // Ritk√°bb szinkron el√©g
    }

    // --- MEGOSZT√ÅS FUNKCI√ìK ---
    async function shareAccess() {
        const currentUrl = window.location.href.split('?')[0];
        const isWeb = currentUrl.startsWith('http');
        
        const shareData = {
            title: 'Csal√°di Napl√≥ Bel√©p√©s',
            text: `Szia! Itt a csal√°di napl√≥ k√≥dja: ${state.pantryId}`,
            url: isWeb ? `${currentUrl}?id=${state.pantryId}` : undefined
        };

        if (navigator.share) {
            try {
                await navigator.share(shareData);
            } catch (err) {
                console.log('Megoszt√°s megszak√≠tva');
            }
        } else {
            // Ha nem t√°mogatott a nat√≠v megoszt√°s (pl. PC), m√°soljuk v√°g√≥lapra
            copyIdToClipboard();
            alert("A k√≥d a v√°g√≥lapra m√°solva! K√ºldd el Messengeren.");
        }
    }

    function copyIdToClipboard() {
        navigator.clipboard.writeText(state.pantryId).then(() => {
            alert("K√≥d kim√°solva: " + state.pantryId);
        });
    }

    // --- API & DATA ---
    async function fetchData() {
        updateSyncStatus('syncing');
        const url = `${PANTRY_BASE}${state.pantryId}/basket/${BASKET_NAME}`;
        try {
            const res = await fetch(url);
            if (!res.ok) {
                if(res.status === 400 || res.status === 404) { await saveData(true); return; }
                throw new Error("Hiba");
            }
            const data = await res.json();
            state.tasks = data.tasks || [];
            state.dailyLog = data.dailyLog || {};
            state.categories = data.categories || [];
            renderManageList(); renderToday(); updateSyncStatus('online');
        } catch (e) { updateSyncStatus('error'); }
    }

    async function saveData(isInit = false) {
        updateSyncStatus('syncing');
        const url = `${PANTRY_BASE}${state.pantryId}/basket/${BASKET_NAME}`;
        const payload = { tasks: state.tasks, dailyLog: state.dailyLog, categories: state.categories, lastUpdate: Date.now() };
        try {
            await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            updateSyncStatus('online');
            if(!isInit) renderToday();
        } catch(e) { updateSyncStatus('error'); }
    }

    function updateSyncStatus(s) {
        const el = document.getElementById('sync-status');
        if(s==='syncing') { el.innerText = '‚åõ'; el.className = 'sync-badge'; }
        else if(s==='online') { el.innerText = '‚òÅÔ∏è OK'; el.className = 'sync-badge active'; }
        else { el.innerText = '‚ö†Ô∏è Hiba'; el.style.background='red'; el.style.color='white'; }
    }

    // --- UI LOGIKA (R√∂vid√≠tve a l√©nyegre) ---
    function getTodayStr() { return state.currentDateObj.toISOString().split('T')[0]; }
    
    function renderToday() {
        const list = document.getElementById('task-list'); list.innerHTML = '';
        const todayStr = getTodayStr();
        let dailyItems = state.dailyLog[todayStr] || [];
        
        // Auto-gener√°l√°s
        state.tasks.forEach(t => {
            if (!dailyItems.some(i => i.taskId === t.id) && isTaskDue(t, state.currentDateObj)) {
                dailyItems.push({ taskId: t.id, name: t.name, cat: t.cat||'Egy√©b', status: 'todo' });
            }
        });
        if (JSON.stringify(state.dailyLog[todayStr]) !== JSON.stringify(dailyItems)) state.dailyLog[todayStr] = dailyItems;

        let allDone = true;
        if(dailyItems.length === 0) allDone = false;

        dailyItems.forEach((item, idx) => {
            if(item.status === 'todo') allDone = false;
            let cls = item.status === 'done' ? 'status-done' : (item.status === 'skipped' ? 'status-skipped' : 'status-todo');
            let btns = item.status === 'todo' ? `
                <div class="btn-row">
                    <button class="btn-skip" onclick="updateStatus('${todayStr}',${idx},'skipped')">üö´</button>
                    <button class="btn-done" onclick="updateStatus('${todayStr}',${idx},'done')">K√©sz</button>
                </div>` : (item.status==='done' ? `<div style="margin-top:5px; color:#00b894; font-weight:bold;">‚úÖ K√©sz</div>` : '');
            
            list.innerHTML += `<div class="card ${cls}"><div class="task-header"><div><b>${item.name}</b><br><small>${item.cat}</small></div></div>${btns}</div>`;
        });
        document.getElementById('empty-msg').style.display = allDone ? 'block' : 'none';
    }

    function updateStatus(d,i,s) { state.dailyLog[d][i].status = s; renderToday(); saveData(); }
    
    function addNewTask() {
        const name = document.getElementById('new-name').value;
        if(!name) return alert("N√©v kell!");
        const cat = document.getElementById('new-cat').value;
        const type = document.getElementById('freq-type').value;
        let t = { id: 't_'+Date.now(), name, cat, freqType: type, startDate: new Date().toISOString() };
        
        if(type==='weekly_days') {
            let days=[]; document.querySelectorAll('.day-btn.selected').forEach(e=>{ if(e.innerText=='H') days.push(1); /* stb */ }); 
            // Egyszer≈±s√≠t√©s: Ha √ºres, minden nap
            t.days = days.length ? days : [0,1,2,3,4,5,6];
        }
        else if(type==='interval_week') t.interval = document.getElementById('interval-week-num').value;
        else if(type==='monthly_fix') t.monthDay = document.getElementById('month-day-fix').value;

        if(cat && !state.categories.includes(cat)) state.categories.push(cat);
        state.tasks.push(t); saveData(); alert("Mentve!"); document.getElementById('new-name').value='';
    }

    function deleteTask(id) { if(confirm("T√∂rl√©s?")) { state.tasks=state.tasks.filter(x=>x.id!==id); saveData(); } }

    function isTaskDue(t, date) {
        const d = date.getDate(); const day = date.getDay();
        if(t.freqType === 'every_day') return true;
        if(t.freqType === 'weekly_days') return t.days ? t.days.includes(day) : true;
        if(t.freqType === 'monthly_fix') return d == t.monthDay;
        // Egyszer≈±s√≠tett intervallum logika
        if(t.freqType === 'interval_week') {
             const diff = Math.floor((date - new Date(t.startDate))/(86400000));
             return diff % (t.interval*7) === 0;
        }
        return false;
    }

    // UI Seg√©d
    function changeDay(o) { state.currentDateObj.setDate(state.currentDateObj.getDate()+o); updateDateDisplay(); renderToday(); }
    function updateDateDisplay() { document.getElementById('today-date').innerText = state.currentDateObj.toLocaleDateString('hu-HU',{weekday:'short', month:'short', day:'numeric'}); }
    function renderManageList() { document.getElementById('manage-list').innerHTML = state.tasks.map(t=>`<div class="card" style="display:flex; justify-content:space-between;">${t.name} <button class="btn-danger" style="flex:0; padding:5px 10px;" onclick="deleteTask('${t.id}')">X</button></div>`).join(''); }
    function renderFreqOptions() { /* Egyszer≈±s√≠tett logika a l√°that√≥s√°gra... */ 
        const v = document.getElementById('freq-type').value;
        document.getElementById('opt-weekly-days').style.display = v==='weekly_days'?'block':'none';
        document.getElementById('opt-interval-week').style.display = v==='interval_week'?'block':'none';
        document.getElementById('opt-monthly-fix').style.display = v==='monthly_fix'?'block':'none';
    }
    function toggleDay(e) { e.classList.toggle('selected'); }
    function filterCats() { 
        const div = document.getElementById('cat-chips'); div.innerHTML='';
        state.categories.forEach(c=>div.innerHTML+=`<div class="chip" onclick="document.getElementById('new-cat').value='${c}'">${c}</div>`);
    }
    window.switchTab = function(id, el) { 
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); if(el) el.classList.add('active');
    }
</script>
</body>
</html>
